# Generating policies using ACM Policy Generator and GitOps

[ZTP container](../resource-generator/README.md) provides a list of default [source CRs](https://github.com/openshift-kni/telco-reference/tree/main/telco-ran/configuration/source-crs/README.md) to distribute the RAN configurations via ACM policies generated by [ZTP Policy Generator](../policygenerator/README.md). If you have configuration CRs or validation CRs to be applied to managed clusters but are not provided in the ZTP container, you could use the [ACM Policy Generator](https://github.com/stolostron/policy-generator-plugin) to help building your custom policies.

## Building custom validator policy using ACM Policy Generator
This example describes how to generate a custom validator policy that validates the extra resources within the ZTP workflow.

* Create the source files with the CRs you want to validate in a directory `custom_source_crs/validationCRs/`. The following example checks a `LocalVolume` available status:
```
apiVersion: local.storage.openshift.io/v1
kind: LocalVolume
metadata:
  name: fs
  namespace: openshift-local-storage
status:
  conditions:
  - status: "True"
    type: Available
```
Note: This CR contains only `status` fields. This results in a policy which is used only for validation and will not modify the configuration state of the cluster.

* Create a `PlacementRule` manifest called `validator-placementrule.yaml`.
```
apiVersion: apps.open-cluster-management.io/v1
kind: PlacementRule
metadata:
    name: extended-validator-placementrules
    namespace: ztp-group
spec:
    clusterSelector:
        matchExpressions:
            - key: group-du-sno
              operator: Exists
            - key: ztp-done
              operator: DoesNotExist
```

* Create a ACM Policy Generator configuration file called `extended-du-validator.yaml`
```
apiVersion: policy.open-cluster-management.io/v1
kind: PolicyGenerator
metadata:
  name: extended-du-validator
policyDefaults:
  policyAnnotations: {"ran.openshift.io/ztp-deploy-wave": "10001"}
  evaluationInterval:
    compliant: 10m
    noncompliant: 10s
  namespace: "ztp-group"
  placement:
    placementRulePath: validator-placementrule.yaml
  remediationAction: inform
  complianceType: musthave
policies:
- name: "extended-du-validator-policy"
  manifests:
    - path: custom_source_crs/validationCRs/
```

The annotation "ran.openshift.io/ztp-deploy-wave" is required to be added in the policy for [TALM](https://github.com/openshift-kni/cluster-group-upgrades-operator) to know the order of policies to be applied/checked. This can be done via `policyDefaults.policyAnnotations` as shown above. Note: The du validator policy created in this ZTP [PolicyGenTemplate](argocd/example/policygentemplates/group-du-sno-validator-ranGen.yaml) is default to wave 10000, set the extended-du-validator policy to wave 10001 so it will be checked next to the du validator policy.

* Add `extended-du-validator.yaml` in the `kustomization.yaml` file as a generator.


See [ACM PolicyGenerator reference YAML](https://github.com/stolostron/policy-generator-plugin/blob/main/docs/policygenerator-reference.yaml) for the full structure of `PolicyGenerator`. 

## Intergrating with GitOps
To use ACM Policy Generator within the GitOps ZTP workflow, you could intergrate it with Openshift GitOps(ArgoCD). ACM GitOps is another GitOps tool can be used and in ACM 2.4+, this intergration comes out-of-the-box. Both of them will work equivalently.

### Openshift GitOps(ArgoCD)
As ACM Policy Generator is not preinstalled in the Openshift GitOps container image, these steps describes how to do integrate it with Openshift GitOps.

**Requirements**:
1. Advanced Cluster Management(ACM) operator v2.4+ installed on the hub cluster
1. Redhat Openshift GitOps operator v1.4+ installed and patched with [ZTP container](argocd/deployment/argocd-openshift-gitops-patch.json) on the hub cluster

**Steps**:
1. Patch the ArgoCD to copy the policy generator binary from the ACM application subscription container image to the ArgoCD container.
* Get the current `argocd` object
```
oc get argocd -n openshift-gitops openshift-gitops -o json > openshift-gitops-argocd.json 
```
* Edit the downloaded `openshift-gitops-argocd.json`file with the ACM subscription image added in the `initContainers` like in the example.
```
{
  "spec": {
    "repo": {
      "initContainers": [
        ...
        {
          "name": "acm-policy-generator",
          "command": [
            "/bin/bash"
          ],
          "args": [
            "-c",
            "cp -r /etc/kustomize /.config"
          ],
          "imagePullPolicy": "Always",
          "volumeMounts": [
            {
              "name": "kustomize",
              "mountPath": "/.config"
            }
          ],
          "image": "quay.io/stolostron/multicluster-operators-subscription:2.5.0"
        }
      ]
    }
  }
}
```
* Apply the patch
```
oc patch argocd openshift-gitops -n openshift-gitops --type=merge --patch-file openshift-gitops-argocd.json
```

2. Update the existing `AppProject` for policy app created via [policy-app-project.yaml](argocd/deployment/policies-app-project.yaml) with the `PolicyGenerator` object.
```
oc edit appprojects.argoproj.io -n openshift-gitops policy-app-project

spec:
  namespaceResourceWhitelist:
  - group: policy.open-cluster-management.io/v1
    kind: PolicyGenerator
```

3. Push the prepared custom source files and `PolicyGenerator` yamls to the Git respository, ArgoCD will detect the changes and generate the policies.
Note: you could push to the same Git directory where the ZTP PolicyGenTemplates are defined in and have one Argo Policy application to manage them or a new directory and create a new Argo application with that directory to roll out the changes.

### ACM GitOps
As ACM Policy Generator is preinstalled in ACM application management, no more configuration is necessary to enable it. These steps describes how to use ACM application subscription workflow to distribute the policies. 

**Requirements**:
* Advanced Cluster Management(ACM) operator v2.4+ installed on the hub cluster

**Steps**:
1. You need to become a subscription administrator in order to deploy policies using ACM subscription
* Add an entry for your user to the existing `ClusterRoleBinding` named `open-cluster-management:subscription-admin`. The new entry should be similar to the following:
```
subjects:
- apiGroup: rbac.authorization.k8s.io
  kind: User
  name: system:admin
- apiGroup: rbac.authorization.k8s.io
  kind: Group
  name: system:cluster-admins
```

2. Create and apply the ACM Subscription/Channel resources   
```
apiVersion: v1
kind: Namespace
metadata:
  name: ztp-acm-app
---
apiVersion: apps.open-cluster-management.io/v1
kind: Channel
metadata:
  name: ztp-gitops
  namespace: ztp-acm-app
spec:
  type: Git
  pathname: <your-git-repository-url>
---
apiVersion: apps.open-cluster-management.io/v1
kind: Subscription
metadata:
  name: acm-policies-sub
  namespace: ztp-acm-app
  labels:
    app: acm-policies
  annotations:
    apps.open-cluster-management.io/github-branch: master
    apps.open-cluster-management.io/github-path: config-acm
    apps.open-cluster-management.io/reconcile-option: merge
spec:
  channel: ztp-acm-app/ztp-gitops
  placement:
    local: true
``` 

3. Push the prepared custom source files and `PolicyGenerator` yamls to the Git respository in the directory `config-acm` which is subscribed in the above example, ACM will sync the repository and apply the generated policies.


More examples of subscriptions, see https://github.com/stolostron/application-samples/tree/main/subscriptions.
