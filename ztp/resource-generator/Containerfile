# Builder
FROM registry.ci.openshift.org/ocp/builder:rhel-8-golang-1.20-openshift-4.15 as builder
ARG IMAGE_REF
USER root
ENV PKG_ROOT=cnf-features-deploy
ENV PKG_PATH=/go/src/$PKG_ROOT
ENV PGT_ROOT=$PKG_PATH/ztp/policygenerator-kustomize-plugin
ENV SC_ROOT=$PKG_PATH/ztp/siteconfig-generator-kustomize-plugin
ENV AZTP_EXTRACTOR_ROOT=$PKG_PATH/ztp/aztp-extractor
RUN mkdir -p $PKG_PATH
WORKDIR $PKG_PATH/
COPY . .
WORKDIR $PKG_PATH/ztp/resource-generator
RUN ./tools/patchImageReference.sh ../gitops-subscriptions $IMAGE_REF
WORKDIR $PGT_ROOT
RUN make build
WORKDIR $SC_ROOT
RUN make build
WORKDIR $AZTP_EXTRACTOR_ROOT
RUN make build

# Container image
FROM ubi8-minimal
USER root
ENV BUILDER_ZTP=/go/src/cnf-features-deploy/ztp
ENV ZTP_HOME=/home/ztp
# Install utilities needed by the entrypoint scripts
RUN microdnf install tar util-linux
# Copy in the kustomize plugin directory structure
COPY --from=builder $BUILDER_ZTP/policygenerator-kustomize-plugin/kustomize /kustomize
COPY --from=builder $BUILDER_ZTP/siteconfig-generator-kustomize-plugin/kustomize /kustomize
# Copy in the examples and source-cr files
RUN mkdir -p $ZTP_HOME
WORKDIR $ZTP_HOME
COPY --from=builder $BUILDER_ZTP/source-crs source-crs
COPY --from=builder $BUILDER_ZTP/source-crs/extra-manifest extra-manifest
COPY --from=builder $BUILDER_ZTP/gitops-subscriptions/argocd argocd
RUN chown -R 1001:1001 $ZTP_HOME
# Copy in the entrypoint scripts
COPY --from=builder $BUILDER_ZTP/resource-generator/entrypoints/* /usr/bin
COPY --chown=1001 --from=builder $BUILDER_ZTP/resource-generator/exportkustomize.sh /
COPY --chown=1001 --from=builder $BUILDER_ZTP/aztp-extractor/aztp-extractor /usr/bin/
USER 1001
CMD entrypoints

# Note: any edits made to this file MUST be manually synchronised with the midstream build configuration:
# - please choose appropriate branch:
# https://gitlab.cee.redhat.com/cpaas-midstream/telco-5g-ran/ztp-site-generate/-/blob/rhaos-4.15-rhel-9/distgit/containers/ztp-site-generate/Dockerfile.in?ref_type=heads
# - include cpaas owners as reviewers: @Nishant Parekh , @rauherna
# Warning: before updating builder image version, make sure the argocd container has the same version
