apiVersion: machineconfiguration.openshift.io/v1
kind: MachineConfig
metadata:
  labels:
    machineconfiguration.openshift.io/role: master
  name: 04-accelerated-container-startup-master
spec:
  config:
    ignition:
      version: 3.2.0
    storage:
      files:
      - contents:
          source: data:text/plain;charset=utf-8;base64,IyEvYmluL2Jhc2gKIwojIFRlbXBvcmFyaWx5IHJlc2V0IHRoZSBjb3JlIHN5c3RlbSBwcm9jZXNzZXMncyBDUFUgYWZmaW5pdHkgdG8gYmUgdW5yZXN0cmljdGVkIHRvIGFjY2VsbGVyYXRlIHN0YXJ0dXAgYW5kIHNodXRkb3duCiMKIyBUaGUgZGVmYXVsdHMgYmVsb3cgY2FuIGJlIG92ZXJyaWRkZW4gdmlhIGVudmlyb25tZW50IHZhcmlhYmxlcwojCgojIFRoZSBkZWZhdWx0IHNldCBvZiBjcml0aWNhbCBwcm9jZXNzZXMgd2hvc2UgYWZmaW5pdHkgc2hvdWxkIGJlIHRlbXBvcmFyaWx5IHVuYm91bmQ6CkNSSVRJQ0FMX1BST0NFU1NFUz0ke0NSSVRJQ0FMX1BST0NFU1NFUzotInN5c3RlbWQgb3ZzIGNyaW8ga3ViZWxldCBOZXR3b3JrTWFuYWdlciBjb25tb24gZGJ1cyJ9CgojIERlZmF1bHQgd2FpdCB0aW1lIGlzIDYwMHMgPSAxMG06Ck1BWElNVU1fV0FJVF9USU1FPSR7TUFYSU1VTV9XQUlUX1RJTUU6LTYwMH0KCnVucmVzdHJpY3RlZENwdXNldCgpIHsKICBpZiBbWyAhIC1lIC92YXIvbGliL2t1YmVsZXQvY3B1X21hbmFnZXJfc3RhdGUgXV07IHRoZW4KICAgICMgdXNlIGFsbCB0aGUgY3B1cyBpZiBrdWJlbGV0IGlzIG5vdCBjb25maWd1cmVkIHlldAogICAgY2F0IC9zeXMvZnMvY2dyb3VwL2NwdXNldC9jcHVzZXQuY3B1cwogIGVsc2UKICAgIGpxIC1yICcuZGVmYXVsdENwdVNldCcgPC92YXIvbGliL2t1YmVsZXQvY3B1X21hbmFnZXJfc3RhdGUKICBmaQp9CgpyZXN0cmljdGVkQ3B1c2V0KCkgewogIGZvciBhcmcgaW4gJCg8L3Byb2MvY21kbGluZSk7IGRvCiAgICBpZiBbWyAkYXJnID1+IF5zeXN0ZW1kLmNwdV9hZmZpbml0eT0gXV07IHRoZW4KICAgICAgZWNobyAke2FyZyMqPX0KICAgICAgcmV0dXJuIDAKICAgIGZpCiAgZG9uZQogIHJldHVybiAxCn0KCnJlc2V0QWZmaW5pdHkoKSB7CiAgbG9jYWwgY3B1c2V0PSIkMSIKICBsb2NhbCBmYWlsY291bnQ9MAogIGxvY2FsIHN1Y2Nlc3Njb3VudD0wCiAgZWNobyAiPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PSIKICBlY2hvICJTZXR0aW5nIENQVSBhZmZpbml0eSBmb3IgY3JpdGljYWwgcHJvY2Vzc2VzIFwiJENSSVRJQ0FMX1BST0NFU1NFU1wiIHRvICRjcHVzZXQiCiAgZm9yIHByb2MgaW4gJENSSVRJQ0FMX1BST0NFU1NFUzsgZG8KICAgIGxvY2FsIHBpZHM9IiQocGdyZXAgJHByb2MpIgogICAgZm9yIHBpZCBpbiAkcGlkczsgZG8KICAgICAgbG9jYWwgdGFza3NldE91dHB1dAogICAgICB0YXNrc2V0T3V0cHV0PSIkKHRhc2tzZXQgLWFwYyAiJGNwdXNldCIgJHBpZCAyPiYxKSIKICAgICAgaWYgW1sgJD8gLW5lIDAgXV07IHRoZW4KICAgICAgICBlY2hvICJFUlJPUjogJHRhc2tzZXRPdXRwdXQiCiAgICAgICAgKChmYWlsY291bnQrKykpCiAgICAgIGVsc2UKICAgICAgICAoKHN1Y2Nlc3Njb3VudCsrKSkKICAgICAgZmkKICAgIGRvbmUKICBkb25lCiAgbG9nZ2VyICJSZWNvdmVyeTogUmUtYWZmaW5lZCAkc3VjY2Vzc2NvdW50IHBpZHMgc3VjY2Vzc2Z1bGx5IgogIGlmIFtbICRmYWlsY291bnQgLWd0IDAgXV07IHRoZW4KICAgIGxvZ2dlciAiUmVjb3Zlcnk6IEZhaWxlZCB0byByZS1hZmZpbmUgJGZhaWxjb3VudCBwcm9jZXNzZXMiCiAgICByZXR1cm4gMQogIGZpCn0KCnNldFVucmVzdHJpY3RlZCgpIHsKICBsb2dnZXIgIlJlY292ZXJ5OiBTZXR0aW5nIGNyaXRpY2FsIHN5c3RlbSBwcm9jZXNzZXMgdG8gaGF2ZSB1bnJlc3RyaWN0ZWQgQ1BVIGFjY2VzcyIKICByZXNldEFmZmluaXR5ICIkKHVucmVzdHJpY3RlZENwdXNldCkiCn0KCnNldFJlc3RyaWN0ZWQoKSB7CiAgbG9nZ2VyICJSZWNvdmVyeTogUmVzZXR0aW5nIGNyaXRpY2FsIHN5c3RlbSBwcm9jZXNzZXMgYmFjayB0byBub3JtYWxseSByZXN0cmljdGVkIGFjY2VzcyIKICByZXNldEFmZmluaXR5ICIkKHJlc3RyaWN0ZWRDcHVzZXQpIgp9CgpjdXJyZW50QWZmaW5pdHkoKSB7CiAgbG9jYWwgcGlkPSIkMSIKICB0YXNrc2V0IC1wYyAkcGlkIHwgYXdrIC1GJzogJyAne3ByaW50ICQyfScKfQoKd2FpdEZvclJlYWR5KCkgewogIGxvZ2dlciAiUmVjb3Zlcnk6IFdhaXRpbmcgJHtNQVhJTVVNX1dBSVRfVElNRX1zIGZvciB0aGUgaW5pdGlhbGl6YXRpb24gdG8gY29tcGxldGUiCiAgbG9jYWwgbGFzdFN5c3RlbWRDcHVzZXQ9IiQoY3VycmVudEFmZmluaXR5IDEpIgogIGxvY2FsIGxhc3REZXNpcmVkQ3B1c2V0PSIkKHVucmVzdHJpY3RlZENwdXNldCkiCiAgbG9jYWwgdD0wIHM9MTAKICB3aGlsZSBbWyAkdCAtbHQgJE1BWElNVU1fV0FJVF9USU1FIF1dOyBkbwogICAgc2xlZXAgJHMKICAgICgodCArPSBzKSkKICAgICMgUmUtY2hlY2sgdGhlIGN1cnJlbnQgYWZmaW5pdHkgb2Ygc3lzdGVtZCwgaW4gY2FzZSBzb21lIG90aGVyIHByb2Nlc3MgaGFzIGNoYW5nZWQgaXQKICAgIGxvY2FsIHN5c3RlbWRDcHVzZXQ9IiQoY3VycmVudEFmZmluaXR5IDEpIgogICAgIyBSZS1jaGVjayB0aGUgdW5yZXN0cmljdGVkIENwdXNldCwgYXMgdGhlIGFsbG93ZWQgc2V0IG9mIHVucmVzZXJ2ZWQgY29yZXMgbWF5IGNoYW5nZSBhcyBwb2RzIGFyZSBhc3NpZ25lZCB0byBjb3JlcwogICAgbG9jYWwgZGVzaXJlZENwdXNldD0iJCh1bnJlc3RyaWN0ZWRDcHVzZXQpIgogICAgaWYgW1sgJHN5c3RlbWRDcHVzZXQgIT0gJGxhc3RTeXN0ZW1kQ3B1c2V0IHx8ICRsYXN0RGVzaXJlZENwdXNldCAhPSAkZGVzaXJlZENwdXNldCBdXTsgdGhlbgogICAgICByZXNldEFmZmluaXR5ICIkZGVzaXJlZENwdXNldCIKICAgICAgbGFzdFN5c3RlbWRDcHVzZXQ9IiQoY3VycmVudEFmZmluaXR5IDEpIgogICAgICBsYXN0RGVzaXJlZENwdXNldD0iJGRlc2lyZWRDcHVzZXQiCiAgICBmaQogIGRvbmUKICBsb2dnZXIgIlJlY292ZXJ5OiBSZWNvdmVyeSBDb21wbGV0ZSBUaW1lb3V0Igp9CgppZiAhIHVucmVzdHJpY3RlZENwdXNldCA+Ji9kZXYvbnVsbDsgdGhlbgogIGxvZ2dlciAiUmVjb3Zlcnk6IE5vIHVucmVzdHJpY3RlZCBDcHVzZXQgY291bGQgYmUgZGV0ZWN0ZWQiCiAgZXhpdCAxCmZpCgppZiAhIHJlc3RyaWN0ZWRDcHVzZXQgPiYvZGV2L251bGw7IHRoZW4KICBsb2dnZXIgIlJlY292ZXJ5OiBObyByZXN0cmljdGVkIENwdXNldCBoYXMgYmVlbiBjb25maWd1cmVkLiAgV2UgYXJlIGFscmVhZHkgcnVubmluZyB1bnJlc3RyaWN0ZWQuIgogIGV4aXQgMApmaQoKIyBFbnN1cmUgd2UgcmVzZXQgdGhlIENQVSBhZmZpbml0eSB3aGVuIHdlIGV4aXQgdGhpcyBzY3JpcHQgZm9yIGFueSByZWFzb24KIyBUaGlzIHdheSBlaXRoZXIgYWZ0ZXIgdGhlIHRpbWVyIGV4cGlyZXMgb3IgYWZ0ZXIgdGhlIHByb2Nlc3MgaXMgaW50ZXJydXB0ZWQKIyB2aWEgXkMgb3IgU0lHVEVSTSwgd2UgcmV0dXJuIHRoaW5ncyBiYWNrIHRvIHRoZSB3YXkgdGhleSBzaG91bGQgYmUuCnRyYXAgc2V0UmVzdHJpY3RlZCBFWElUCgpsb2dnZXIgIlJlY292ZXJ5OiBSZWNvdmVyeSBNb2RlIFN0YXJ0aW5nIgpzZXRVbnJlc3RyaWN0ZWQKd2FpdEZvclJlYWR5Cg==
        mode: 493
        path: /usr/local/bin/accelerated-container-startup.sh
    systemd:
      units:
      - contents: |
          [Unit]
          Description=Unlocks more CPUs for critical system processes during container startup

          [Service]
          Type=simple
          ExecStart=/usr/local/bin/accelerated-container-startup.sh

          [Install]
          WantedBy=multi-user.target
        enabled: true
        name: accelerated-container-startup.service
      - contents: |
          [Unit]
          Description=Unlocks more CPUs for critical system processes during container shutdown
          DefaultDependencies=no

          [Service]
          Type=simple
          ExecStart=/usr/local/bin/accelerated-container-startup.sh

          [Install]
          WantedBy=shutdown.target reboot.target halt.target
        enabled: true
        name: accelerated-container-shutdown.service
