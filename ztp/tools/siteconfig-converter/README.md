# SiteConfig to ClusterInstance Converter

A command-line tool that converts OpenShift SiteConfig Custom Resources (CRs) to ClusterInstance CRs. The tool provides automated conversion with warnings to the user in limited cases where manual action is required.

### Usage through ztp-site-generate container

Navigate to the directory that SiteConfig manifest is located.
```
cd /path/to/siteconfig/directory/
podman run -v "${PWD}":/resources:Z,U -it ${IMAGE} siteconfig-converter -d /resources/output/ /resources/siteconfig.yaml
```
The manifests will be generated in the `./output` directory

#### Extracting the binaries

```
podman run -d --rm --name ztp ${IMAGE} tail -f /dev/null
podman cp ztp:/usr/bin/siteconfig-converter ./
podman stop ztp
sudo cp siteconfig-converter siteconfig-generator /usr/local/bin

siteconfig-converter -d output-cluster-instance cnfdf26.yaml
tree output-cluster-instance
output-cluster-instance
├── cnfdf26.yaml
├── extra-manifests
│   └── 98-var-lib-containers-partitioned.yaml
└── kustomization-configMapGenerator-snippet.yaml
```

### Build from Source

```bash
git clone <repository-url>
cd ztp/tools/siteconfig-converter
make build
```

## Usage

### Basic Usage

```bash
./siteconfig-converter <siteconfig.yaml>
```

### Full Command Syntax

```bash
./siteconfig-converter [-d output_dir] [-t cluster_namespace/name,...] [-n node_namespace/name,...] [-m configmap1,configmap2,...] [-s AgentClusterInstall,ClusterDeployment,...] [-w] [-c] <siteconfig.yaml>
```

### Command-Line Options

| Flag/Argument | Description | Default |
|---------------|-------------|---------|
| `<siteconfig.yaml>` | Path to the SiteConfig YAML file (required positional argument) | - |
| `-d` | Output directory for converted ClusterInstance files (required) | - |
| `-t` | Comma-separated list of template references for Clusters (format: namespace/name,namespace/name,...) | `open-cluster-management/ai-cluster-templates-v1` |
| `-n` | Comma-separated list of template references for Nodes (format: namespace/name,namespace/name,...) | `open-cluster-management/ai-node-templates-v1` |
| `-m` | Comma-separated list of ConfigMap names for extra manifests references | - |
| `-s` | Comma-separated list of manifest names to suppress at cluster level | - |
| `-w` | Write conversion warnings as comments to the head of converted YAML files | `false` |
| `-c` | Copy comments from the original SiteConfig to the converted ClusterInstance files | `false` |


## Examples

```bash
./siteconfig-converter -d ./output sno-siteconfig.yaml

# With warnings written to YAML files
./siteconfig-converter -d ./output -w sno-siteconfig.yaml
```

### Custom Templates

```bash
# Use custom cluster and node templates
./siteconfig-converter \
  -d ./output \
  -t my-namespace/custom-cluster-template \
  -n my-namespace/custom-node-template \
  siteconfig.yaml
```

### Multiple Templates

```bash
# Use multiple cluster and node templates (comma-separated)
./siteconfig-converter \
  -d ./output \
  -t cluster-ns1/cluster-template1,cluster-ns2/cluster-template2,cluster-ns3/cluster-template3 \
  -n node-ns1/node-template1,node-ns2/node-template2 \
  siteconfig.yaml

# Mix single and multiple templates
./siteconfig-converter \
  -d ./output \
  -t my-namespace/cluster-template \
  -n node-ns1/node-template1,node-ns2/node-template2,node-ns3/node-template3 \
  siteconfig.yaml
```

#### Live Cluster Migration

When migrating a live cluster, the manifests generated by ClusterInstance must exactly match those already deployed. However, due to API deprecation, ClusterInstance cannot replicate older versions of `AgentClusterInstall` resources that use deprecated fields. Specifically, this affects clusters with the following deprecated fields: `apiVIP`, `ingressVIP`, and `manifestsConfigMapRef`.  Note that the plural forms of these fields `apiVIPs, ingressVIPs, manifestsConfigMapRefs` are not deprecated and do not impact conversion to ClusterInstance.

If you attempt to live migrate a cluster with any of these deprecated fields, you will encounter an error when applying the ClusterInstance CR to the hub cluster, similar to this:

```
message: "failed to update resource during patch operation: admission webhook
\"agentclusterinstallvalidators.admission.agentinstall.openshift.io\" denied
the request: Attempted to change AgentClusterInstall.Spec which is immutable
after install started, except for ClusterMetadata,IgnitionEndpoint fields.
Unsupported change: \n\tManifestsConfigMapRefs: ([] => [{Name:sno1}])"
```

**Before performing the migration**, verify whether the existing `AgentClusterInstall` resource on the hub cluster contains any of these deprecated fields. If it does, you have two resolution options:

**Option 1: Create a Custom Cluster Template**

Create a ConfigMap that contains the custom cluster template that uses the deprecated singular field forms instead of the current plural forms. The following diff shows the differences between the original template and the custom template:

```
$ diff original_ai-cluster-templates.yaml single-vip.yaml 
21,22c21
<       apiVIPs:
<     {{ .Spec.ApiVIPs | toYaml | indent 4 }}
---
>       apiVIP: "{{ index .Spec.ApiVIPs 0 }}"
25,26c24
<       ingressVIPs:
<     {{ .Spec.IngressVIPs | toYaml | indent 4 }}
---
>       ingressVIP: "{{ index .Spec.IngressVIPs 0 }}"
57,58c55,56
<       manifestsConfigMapRefs:
<     {{ .Spec.ExtraManifestsRefs | toYaml | indent 4 }}
---
>       manifestsConfigMapRef:
>     {{ index .Spec.ExtraManifestsRefs 0 | toYaml | indent 4 }}
144c142
<   name: ai-cluster-templates-v1
---
>   name: ai-single-vip-cluster-templates-v1
```

After creating this ConfigMap, reference it through the `templateRefs` field of the cluster in your `ClusterInstance` resource.

**Important**: When redeploying the cluster later, revert to using the default templates instead of this custom template.

**Option 2: Suppress AgentClusterInstall Creation**

Suppress the creation of the `AgentClusterInstall` resource by adding it to the `suppressedManifests` list using the `-s` flag:

```bash
./siteconfig-converter -s AgentClusterInstall siteconfig.yaml
```

**Important**: Remember to remove this suppression before redeploying the cluster to ensure proper resource creation.

### Creating Custom Templates

For detailed information on creating custom templates, refer to the [SiteConfig documentation](https://docs.redhat.com/en/documentation/red_hat_advanced_cluster_management_for_kubernetes/2.13/html/multicluster_engine_operator_with_red_hat_advanced_cluster_management/siteconfig-intro#create-custom-templates).

### Creating HostFirmware Custom Templates

Instead of using `biosConfigRef`, you can create a custom template for HostFirmware settings. Create a ConfigMap containing your BIOS configuration:

```yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: custom-host-firmware
  namespace: my-namespace
data:
  HostFirmwareSettings: |-
    apiVersion: metal3.io/v1alpha1
    kind: HostFirmwareSettings
    metadata:
      name: "{{ .SpecialVars.CurrentNode.HostName }}"
      namespace: "{{ .Spec.ClusterName }}"
    spec:
      ### BIOS config content
      # settings:
      #   BootMode: Uefi
```

Generate the ClusterInstance by referencing this ConfigMap:

```bash
./siteconfig-converter \
  -d ./output \
  -n my-namespace/custom-host-firmware,open-cluster-management/ai-node-templates-v1 \
  siteconfig.yaml
```

### Extra Manifests References

```bash
# Add extra manifests references from ConfigMaps
./siteconfig-converter \
  -m extra-manifests-cm1,extra-manifests-cm2,my-custom-manifests \
  siteconfig.yaml

# Combine with other options
./siteconfig-converter \
  -d ./output \
  -t my-namespace/custom-cluster-template \
  -n my-namespace/custom-node-template \
  -m extra-manifests-cm1,extra-manifests-cm2 \
  siteconfig.yaml

# Combine multiple templates with extra manifests
./siteconfig-converter \
  -d ./output \
  -t cluster-ns1/cluster-template1,cluster-ns2/cluster-template2 \
  -n node-ns1/node-template1,node-ns2/node-template2 \
  -m extra-manifests-cm1,extra-manifests-cm2 \
  siteconfig.yaml
```

### Automatic Extra Manifest Generation

The `siteconfig-converter` tool automatically generates ConfigMap kustomization files by default.

```bash
# Generate ConfigMap kustomization files automatically
./siteconfig-converter -d ./output siteconfig.yaml
```

This process:
1. Creates the `extra-manifests` directory in the output directory
2. Extracts all the extra manifests into this directory
3. Creates a `kustomization-configMapGenerator-snippet.yaml` file which includes a kustomize `configMapGenerator` that will sync the extra manifests ConfigMap on the hub cluster.

The extra manifest ConfigMap is automatically added to the `extraManifestRefs` field of the `ClusterInstance`.

**Example Directory Structure:**

```
$ tree .
├── cnfdf28.yaml
├── extra-manifests
│   ├── 98-var-lib-containers-partitioned.yaml
│   └── set-core-user-password.yaml
├── kustomization.yaml
├── ns.yaml
└── secret.yaml

$ siteconfig-converter -d output cnfdf28.yaml
...

$ tree output
output
├── cnfdf28.yaml
├── extra-manifests
│   ├── 98-var-lib-containers-partitioned.yaml
│   └── set-core-user-password.yaml
└── kustomization-configMapGenerator-snippet.yaml
```

You can merge the generated kustomization file with your original one to generate the ConfigMap and the `ClusterInstance`.

For the complete directory structure and detailed workflow, refer to the [SiteConfig documentation](https://github.com/stolostron/siteconfig/blob/main/docs/argocd.md#generate-extra-manifests-configmap-using-kustomize).

### Suppressed Manifests

```bash
# Add cluster-level suppressed manifests
./siteconfig-converter \
  -s AgentClusterInstall,ClusterDeployment \
  siteconfig.yaml

# Combine with other options
./siteconfig-converter \
  -d ./output \
  -m extra-manifests-cm1,extra-manifests-cm2 \
  -s AgentClusterInstall,BareMetalHost \
  siteconfig.yaml

# Combine multiple templates with suppressed manifests
./siteconfig-converter \
  -d ./output \
  -t cluster-ns1/cluster-template1,cluster-ns2/cluster-template2 \
  -n node-ns1/node-template1,node-ns2/node-template2 \
  -s AgentClusterInstall,BareMetalHost \
  siteconfig.yaml
```

The tool automatically translates `crSuppressions` from SiteConfig to `suppressedManifests` in ClusterInstance. When migrating a live cluster, you can suppress `AgentClusterInstall` to avoid mutation errors. **Important**: Remember to remove the `AgentClusterInstall` suppression when reinstalling the cluster.

### Conversion Warnings

By default, conversion warnings are printed to the console. Use the `-w` flag to write warnings as comments to the converted YAML files instead.

```bash
# Default behavior - warnings printed to console
./siteconfig-converter -d ./output siteconfig.yaml

# Write warnings as comments to YAML files
./siteconfig-converter -d ./output -w siteconfig.yaml

# Combine with other options
./siteconfig-converter \
  -d ./output \
  -t cluster-ns1/cluster-template1,cluster-ns2/cluster-template2 \
  -n node-ns1/node-template1,node-ns2/node-template2 \
  -m extra-manifests-cm1,extra-manifests-cm2 \
  -s AgentClusterInstall,BareMetalHost \
  -w \
  siteconfig.yaml
```

When using the `-w` flag, warnings appear as comments at the beginning of each converted YAML file:

```yaml
---
# Conversion Warnings:
# - extraManifests field is not supported in ClusterInstance and will be ignored...
# - crTemplates field at cluster level is not supported in ClusterInstance...
#
apiVersion: siteconfig.open-cluster-management.io/v1alpha1
kind: ClusterInstance
metadata:
  name: cluster-name
  namespace: cluster-namespace
spec:
  # ... cluster configuration ...
```

### Copying Comments

Use the `-c` flag to copy comments from the original SiteConfig to the converted ClusterInstance YAML files:

```bash
# Copy comments from SiteConfig to ClusterInstance
./siteconfig-converter -c siteconfig.yaml

# Combine with other options
./siteconfig-converter -d ./output -c -w siteconfig.yaml
```

When using the `-c` flag, comments from the original SiteConfig are preserved in the ClusterInstance:

#### Field-specific Comments

Comments associated with specific fields are placed near those fields:

```yaml
# Original SiteConfig
spec:
  # Base domain for the cluster
  baseDomain: example.com
  # Pull secret reference for container images
  pullSecretRef:
    name: pull-secret
  clusters:
  - # Cluster configuration
    clusterName: test-cluster
    # Network type for the cluster
    networkType: OVNKubernetes
```

Becomes:

```yaml
# ClusterInstance with copied comments
spec:
  # Base domain for the cluster
  baseDomain: example.com
  # Pull secret reference for container images
  pullSecretRef:
    name: pull-secret
  # Cluster configuration  
  clusterName: test-cluster
  # Network type for the cluster
  networkType: OVNKubernetes
```

#### Header Comments

Comments not associated with specific fields (such as top-level comments, metadata comments, or comments on unsupported fields) are collected and placed in a header section:

```yaml
# Original SiteConfig
# This is a comprehensive SiteConfig example
# Author: Platform Team
apiVersion: ran.openshift.io/v1
kind: SiteConfig
metadata:
  # This is the metadata section
  name: example-cluster
  # Additional labels
  labels:
    environment: production
spec:
  # Base domain for the cluster
  baseDomain: example.com
```

Becomes:

```yaml
---
# Comments from original SiteConfig:
# This is a comprehensive SiteConfig example
# Author: Platform Team
# This is the metadata section
# Additional labels
#
apiVersion: siteconfig.open-cluster-management.io/v1alpha1
kind: ClusterInstance
metadata:
  name: example-cluster
  namespace: example-cluster
spec:
  # Base domain for the cluster
  baseDomain: example.com
```

## Development

### Running Tests

```bash
# Run all tests
make test

# Run tests with coverage
make test-coverage
```

### Clean Up

```bash
# Clean build artifacts
make clean
```
